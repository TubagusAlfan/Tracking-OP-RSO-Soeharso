<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>ortojejak</title>
    <meta name="description" content="" />
    <meta name="keywords" content="" />

    <link
      href="assets/img/Logo_RSO_Soeharso_Surakarta-removebg-preview.png"
      rel="icon"
    />
    <link href="assets/img/apple-touch-icon.png" rel="apple-touch-icon" />

    <link href="https://fonts.googleapis.com" rel="preconnect" />
    <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&family=Inter:wght@100;200;300;400;500;600;700;800;900&display=swap"
      rel="stylesheet"
    />

    <link
      href="assets/vendor/bootstrap/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="assets/vendor/bootstrap-icons/bootstrap-icons.css"
      rel="stylesheet"
    />
    <link href="assets/vendor/aos/aos.css" rel="stylesheet" />
    <link
      href="assets/vendor/glightbox/css/glightbox.min.css"
      rel="stylesheet"
    />
    <link href="assets/vendor/swiper/swiper-bundle.min.css" rel="stylesheet" />

    <link href="assets/css/main.css" rel="stylesheet" />

    <style>
      /* CSS Anda yang lain... */
    </style>
  </head>

  <body class="index-page">
    <header id="header" class="header d-flex align-items-center fixed-top">
      </header>

    <main class="main">
      <section id="hero" class="hero section dark-background">
        <div
          id="hero-carousel"
          class="carousel slide carousel-fade"
          data-bs-ride="carousel"
          data-bs-interval="5000"
        >
          <div class="carousel-item active">
            <img
              src="assets/img/hero-carousel/latar-belakang-rso-1.jpg"
              alt=""
            />
            <div class="carousel-container">
              <h2>Selamat Datang di ORTOJEJAK</h2>
              <p>
                Website ini adalah portal pelacakan progres pengerjaan alat
                ortotik/prostetik yang memudahkan pasien memantau setiap tahapan
                secara real-time.
              </p>
              <form
                id="regTrackForm"
                class="d-flex flex-column align-items-center mt-4"
                onsubmit="return trackByReg(event)"
              >
                <div class="input-group" style="max-width: 650px">
                  <input
                    id="regSearchInput"
                    type="text"
                    class="form-control"
                    placeholder="Masukkan No. Order untuk Lacak Progres..."
                    aria-label="No. Order"
                    required
                  />
                  <button class="btn btn-outline-info" type="submit">
                    Lacak
                  </button>
                </div>
                </form>
              <div
                id="track-error"
                class="text-warning fw-semibold mt-2"
                style="display: none; font-size: 0.9rem"
              ></div>
            </div>
          </div>
          </div>
      </section>
      </main>

    <footer id="footer" class="footer dark-background">
      </footer>

    <a
      href="#"
      id="scroll-top"
      class="scroll-top d-flex align-items-center justify-content-center"
      ><i class="bi bi-arrow-up-short"></i
    ></a>

    <div id="preloader"></div>

    <div class="modal fade" id="captchaModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Verifikasi Keamanan</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <p class="mb-3">
              Untuk melanjutkan, silakan selesaikan verifikasi di bawah ini.
            </p>
            <div id="recaptchaContainer" class="d-flex justify-content-center"></div>
            <div
              id="recaptcha-error"
              class="text-danger small mt-2 text-center"
              style="display: none"
            ></div>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Batal
            </button>
            <button
              type="button"
              class="btn btn-primary"
              id="recaptchaVerifyBtn"
            >
              Verifikasi
            </button>
          </div>
        </div>
      </div>
    </div>

    <script src="assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
    <script src="assets/vendor/php-email-form/validate.js"></script>
    <script src="assets/vendor/aos/aos.js"></script>
    <script src="assets/vendor/purecounter/purecounter_vanilla.js"></script>
    <script src="assets/vendor/glightbox/js/glightbox.min.js"></script>
    <script src="assets/vendor/imagesloaded/imagesloaded.pkgd.min.js"></script>
    <script src="assets/vendor/isotope-layout/isotope.pkgd.min.js"></script>
    <script src="assets/vendor/swiper/swiper-bundle.min.js"></script>

    <script src="assets/js/main.js"></script>
    <script src="https://www.gstatic.com/firebasejs/12.1.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore-compat.js"></script>
    <script src="../config-firebase.js"></script>
    
    <script src="https://www.google.com/recaptcha/enterprise.js" async defer></script>
    
    <script>
      // --- KONFIGURASI FIREBASE ---
      let trackDb;
      try {
        trackDb = firebase.firestore();
      } catch (e) {
        console.error("Firebase Gagal diinisialisasi:", e);
      }

      // --- KONFIGURASI reCAPTCHA ---
      const RECAPTCHA_SITE_KEY = (window.RECAPTCHA_SITE_KEY || "6LeluLIrAAAAADhkOBCwPt_TLZ1CNrPJ4tB-oDZ6");
      let recaptchaWidgetId = null;

      function waitForRecaptcha(timeoutMs = 8000) {
        return new Promise((resolve, reject) => {
          const start = Date.now();
          (function check() {
            if (typeof grecaptcha !== "undefined" && grecaptcha.enterprise && typeof grecaptcha.enterprise.render === "function") {
              return resolve();
            }
            if (Date.now() - start > timeoutMs) {
              return reject(new Error("reCAPTCHA gagal dimuat."));
            }
            setTimeout(check, 100);
          })();
        });
      }

      // Fungsi ini dipanggil setelah CAPTCHA berhasil diverifikasi
      async function proceedAfterCaptcha(token, reg, modal, errBox) {
        try {
          if (modal) modal.hide(); // Sembunyikan modal
          
          if (!trackDb) {
            errBox.textContent = "Konfigurasi sistem belum siap.";
            errBox.style.display = "block";
            return;
          }
          const snap = await trackDb.collection("patients").doc(reg).get();
          if (!snap.exists) {
            errBox.textContent = "No. order tidak ditemukan.";
            errBox.style.display = "block";
            return;
          }
          const data = snap.data();
          if (!data.token) {
            errBox.textContent = "Data pasien belum siap dilacak.";
            errBox.style.display = "block";
            return;
          }
          window.location.href = `../tracking.html?token=${encodeURIComponent(data.token)}`;
        } catch (err) {
          console.error("Terjadi kesalahan:", err);
          errBox.textContent = "Terjadi kesalahan. Coba lagi.";
          errBox.style.display = "block";
        }
      }

      // --- LOGIKA FORM PENCARIAN (MODAL) ---
      function trackByReg(e) {
        e.preventDefault();
        const input = document.getElementById("regSearchInput");
        const reg = (input.value || "").trim();
        const trackErr = document.getElementById("track-error");
        trackErr.style.display = "none";
        
        if (!reg) return false;

        const modalEl = document.getElementById("captchaModal");
        const modal = new bootstrap.Modal(modalEl);
        const recaptchaErr = document.getElementById("recaptcha-error");

        modal.show();
        recaptchaErr.style.display = "none";

        waitForRecaptcha()
          .then(() => {
            try {
              if (recaptchaWidgetId === null) {
                recaptchaWidgetId = grecaptcha.enterprise.render("recaptchaContainer", {
                  sitekey: RECAPTCHA_SITE_KEY,
                  theme: "light",
                  callback: (token) => {
                    // Otomatis lanjut jika user menyelesaikan tantangan
                    proceedAfterCaptcha(token, reg, modal, trackErr);
                  },
                  'expired-callback': () => {
                    recaptchaErr.textContent = "Sesi reCAPTCHA kedaluwarsa. Mohon verifikasi ulang.";
                    recaptchaErr.style.display = "block";
                  }
                });
              } else {
                grecaptcha.enterprise.reset(recaptchaWidgetId);
              }
            } catch (renderErr) {
              console.error("Gagal merender reCAPTCHA:", renderErr);
              recaptchaErr.textContent = "Gagal memuat reCAPTCHA.";
              recaptchaErr.style.display = "block";
            }
          })
          .catch((loadErr) => {
            console.error("Gagal memuat script reCAPTCHA:", loadErr);
            recaptchaErr.textContent = "reCAPTCHA tidak tersedia. Coba lagi.";
            recaptchaErr.style.display = "block";
          });

        // Handler untuk tombol "Verifikasi" manual di dalam modal
        const verifyBtn = document.getElementById("recaptchaVerifyBtn");
        const newVerifyBtn = verifyBtn.cloneNode(true); // Ganti tombol untuk hapus event listener lama
        verifyBtn.parentNode.replaceChild(newVerifyBtn, verifyBtn);

        newVerifyBtn.addEventListener("click", () => {
          const token = grecaptcha.enterprise.getResponse(recaptchaWidgetId);
          if (!token) {
            recaptchaErr.textContent = "Silakan centang kotak verifikasi.";
            recaptchaErr.style.display = "block";
            return;
          }
          proceedAfterCaptcha(token, reg, modal, trackErr);
        });

        return false;
      }
    </script>
  </body>
</html>

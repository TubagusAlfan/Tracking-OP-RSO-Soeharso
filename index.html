<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>ortojejak</title>
    <meta name="description" content="" />
    <meta name="keywords" content="" />

    <link
      href="assets/img/Logo_RSO_Soeharso_Surakarta-removebg-preview.png"
      rel="icon"
    />
    <link href="assets/img/apple-touch-icon.png" rel="apple-touch-icon" />

    <link href="https://fonts.googleapis.com" rel="preconnect" />
    <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&family=Inter:wght@100;200;300;400;500;600;700;800;900&display=swap"
      rel="stylesheet"
    />

    <link
      href="assets/vendor/bootstrap/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="assets/vendor/bootstrap-icons/bootstrap-icons.css"
      rel="stylesheet"
    />
    <link href="assets/vendor/aos/aos.css" rel="stylesheet" />
    <link
      href="assets/vendor/glightbox/css/glightbox.min.css"
      rel="stylesheet"
    />
    <link href="assets/vendor/swiper/swiper-bundle.min.css" rel="stylesheet" />

    <link href="assets/css/main.css" rel="stylesheet" />

    <style>
      /* CSS Anda yang lain... */
    </style>
  </head>

  <body class="index-page">
    <header
      id="header"
      class="header d-flex align-items-center fixed-top"
    ></header>

    <main class="main">
      <section id="hero" class="hero section dark-background">
        <div
          id="hero-carousel"
          class="carousel slide carousel-fade"
          data-bs-ride="carousel"
          data-bs-interval="5000"
        >
          <div class="carousel-item active">
            <img
              src="assets/img/hero-carousel/latar-belakang-rso-1.jpg"
              alt=""
            />
            <div class="carousel-container">
              <h2>Selamat Datang di ORTOJEJAK</h2>
              <p>
                Website ini adalah portal pelacakan progres pengerjaan alat
                ortotik/prostetik yang memudahkan pasien memantau setiap tahapan
                secara real-time.
              </p>
              <form
                id="regTrackForm"
                class="d-flex flex-column align-items-center mt-4"
                onsubmit="return trackByReg(event)"
              >
                <div class="input-group" style="max-width: 650px">
                  <input
                    id="regSearchInput"
                    type="text"
                    class="form-control"
                    placeholder="Masukkan No. Order untuk Lacak Progres..."
                    aria-label="No. Order"
                    required
                  />
                  <button class="btn btn-outline-info" type="submit">
                    Lacak
                  </button>
                </div>
                <div id="recaptcha-container" class="mt-3"></div>
                <div
                  id="recaptcha-error"
                  class="text-danger small mt-2"
                  style="display: none"
                ></div>
              </form>
              <div
                id="track-error"
                class="text-warning fw-semibold mt-2"
                style="display: none; font-size: 0.9rem"
              ></div>
            </div>
          </div>
        </div>
      </section>
    </main>

    <footer id="footer" class="footer dark-background"></footer>

    <a
      href="#"
      id="scroll-top"
      class="scroll-top d-flex align-items-center justify-content-center"
      ><i class="bi bi-arrow-up-short"></i
    ></a>

    <div id="preloader"></div>

    <script src="assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
    <script src="assets/vendor/php-email-form/validate.js"></script>
    <script src="assets/vendor/aos/aos.js"></script>
    <script src="assets/vendor/purecounter/purecounter_vanilla.js"></script>
    <script src="assets/vendor/glightbox/js/glightbox.min.js"></script>
    <script src="assets/vendor/imagesloaded/imagesloaded.pkgd.min.js"></script>
    <script src="assets/vendor/isotope-layout/isotope.pkgd.min.js"></script>
    <script src="assets/vendor/swiper/swiper-bundle.min.js"></script>

    <script src="assets/js/main.js"></script>
    <script src="https://www.gstatic.com/firebasejs/12.1.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore-compat.js"></script>
    <script src="../config-firebase.js"></script>

    <script
      src="https://www.google.com/recaptcha/enterprise.js"
      async
      defer
    ></script>

    <script>
      // --- KONFIGURASI FIREBASE ---
      let trackDb;
      try {
        trackDb = firebase.firestore();
      } catch (e) {
        console.error("Firebase Gagal diinisialisasi:", e);
      }

      // --- KONFIGURASI reCAPTCHA ---
      const RECAPTCHA_SITE_KEY =
        window.RECAPTCHA_SITE_KEY || "6LeluLIrAAAAADhkOBCwPt_TLZ1CNrPJ4tB-oDZ6";
      let recaptchaWidgetId = null;

      // Fungsi untuk menunggu reCAPTCHA siap
      function waitForRecaptcha(timeoutMs = 8000) {
        return new Promise((resolve, reject) => {
          const start = Date.now();
          (function check() {
            if (
              typeof grecaptcha !== "undefined" &&
              grecaptcha.enterprise &&
              typeof grecaptcha.enterprise.render === "function"
            ) {
              return resolve();
            }
            if (Date.now() - start > timeoutMs) {
              return reject(new Error("reCAPTCHA gagal dimuat."));
            }
            setTimeout(check, 100);
          })();
        });
      }

      // Fungsi untuk merender reCAPTCHA saat halaman dimuat
      function initRecaptcha() {
        const recaptchaErr = document.getElementById("recaptcha-error");
        waitForRecaptcha()
          .then(() => {
            try {
              recaptchaWidgetId = grecaptcha.enterprise.render(
                "recaptcha-container",
                {
                  sitekey: RECAPTCHA_SITE_KEY,
                  theme: "light",
                  size: "normal",
                  callback: function () {
                    if (recaptchaErr) {
                      recaptchaErr.style.display = "none";
                    }
                  },
                  "expired-callback": function () {
                    if (recaptchaErr) {
                      recaptchaErr.textContent =
                        "Sesi reCAPTCHA kedaluwarsa. Mohon verifikasi ulang.";
                      recaptchaErr.style.display = "block";
                    }
                  },
                }
              );
            } catch (renderErr) {
              console.error("Gagal merender reCAPTCHA:", renderErr);
              if (recaptchaErr) {
                recaptchaErr.textContent = "Gagal memuat reCAPTCHA.";
                recaptchaErr.style.display = "block";
              }
            }
          })
          .catch((loadErr) => {
            console.error("Gagal memuat script reCAPTCHA:", loadErr);
            if (recaptchaErr) {
              recaptchaErr.textContent = "reCAPTCHA tidak tersedia. Coba lagi.";
              recaptchaErr.style.display = "block";
            }
          });
      }

      // Jalankan render reCAPTCHA setelah halaman selesai dimuat
      window.addEventListener("load", initRecaptcha);

      // --- LOGIKA FORM PENCARIAN ---
      async function trackByReg(event) {
        event.preventDefault(); // Mencegah form dari reload halaman

        const input = document.getElementById("regSearchInput");
        const reg = (input.value || "").trim();
        const trackErr = document.getElementById("track-error");
        const recaptchaErr = document.getElementById("recaptcha-error");

        // Sembunyikan pesan error sebelumnya
        trackErr.style.display = "none";
        recaptchaErr.style.display = "none";

        if (!reg) {
          // Input kosong, tidak perlu lanjut
          return false;
        }

        // 1. Validasi Token reCAPTCHA
        const token = grecaptcha.enterprise.getResponse(recaptchaWidgetId);
        if (!token) {
          recaptchaErr.textContent =
            "Silakan centang reCAPTCHA untuk verifikasi.";
          recaptchaErr.style.display = "block";
          return false;
        }

        // 2. Lanjutkan ke pencarian data jika reCAPTCHA valid
        try {
          if (!trackDb) {
            trackErr.textContent = "Konfigurasi sistem belum siap.";
            trackErr.style.display = "block";
            return false;
          }

          const snap = await trackDb.collection("patients").doc(reg).get();
          if (!snap.exists) {
            trackErr.textContent = "No. order tidak ditemukan.";
            trackErr.style.display = "block";
            grecaptcha.enterprise.reset(recaptchaWidgetId); // Reset captcha setelah gagal
            return false;
          }

          const data = snap.data();
          if (!data.token) {
            trackErr.textContent = "Data pasien belum siap dilacak.";
            trackErr.style.display = "block";
            grecaptcha.enterprise.reset(recaptchaWidgetId); // Reset captcha
            return false;
          }

          // 3. Arahkan ke halaman pelacakan jika semua berhasil
          window.location.href = `../tracking.html?token=${encodeURIComponent(
            data.token
          )}`;
        } catch (err) {
          console.error("Terjadi kesalahan saat mencari data:", err);
          trackErr.textContent = "Terjadi kesalahan. Coba lagi.";
          trackErr.style.display = "block";
          grecaptcha.enterprise.reset(recaptchaWidgetId); // Reset captcha
        }

        return false;
      }
    </script>
  </body>
</html>
